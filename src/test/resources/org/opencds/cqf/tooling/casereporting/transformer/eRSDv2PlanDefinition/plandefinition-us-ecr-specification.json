{
  "resourceType": "PlanDefinition",
  "id": "plandefinition-us-ecr-specification",
  "meta": {
    "profile": [
      "http://hl7.org/fhir/us/ecr/StructureDefinition/ersd-plandefinition"
    ]
  },
  "text": {
    "status": "extensions",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p><b>Generated Narrative</b></p><div style=\"display: inline-block; background-color: #d9e0e7; padding: 6px; margin: 4px; border: 1px solid #8da1b4; border-radius: 5px; line-height: 60%\"><p style=\"margin-bottom: 0px\">Resource \"plandefinition-ersd-instance-example\" </p><p style=\"margin-bottom: 0px\">Profile: <a href=\"StructureDefinition-ersd-plandefinition.html\">eRSD PlanDefinition</a></p></div><p><b>Variable</b>: <span title=\"text/fhirpath\"><code>2 weeks</code></span>(<b>normalReportingDuration</b>)</p><p><b>url</b>: <code>http://ersd.aimsplatform.org/fhir/PlanDefinition/plandefinition-ersd-instance-example</code></p><p><b>version</b>: 2.0.0</p><p><b>name</b>: PlanDefinition_eRSD_Instance_Example</p><p><b>title</b>: eRSD PlanDefinition Instance Example</p><p><b>type</b>: Workflow Definition <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"http://terminology.hl7.org/3.1.0/CodeSystem-plan-definition-type.html\">PlanDefinitionType</a>#workflow-definition)</span></p><p><b>status</b>: active</p><p><b>experimental</b>: true</p><p><b>date</b>: 2020-07-31 12:32:29-0500</p><p><b>publisher</b>: HL7 Public Health Work Group (http://www.hl7.org/Special/committees/pher/index.cfm)</p><p><b>contact</b>: HL7 International - Public Health: <a href=\"http://www.hl7.org/Special/committees/pher\">http://www.hl7.org/Special/committees/pher</a></p><p><b>description</b>: An example ersd PlanDefinition</p><p><b>jurisdiction</b>: United States of America <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (unknown#US)</span></p><p><b>effectivePeriod</b>: 2020-12-01 --&gt; (ongoing)</p><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the start of the reporting workflow in response to the encounter-start event.</p><p><b>textEquivalent</b>: Start the reporting workflow in response to an encounter-start event</p><p><b>code</b>: Initiate a reporting workflow <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#initiate-reporting-workflow)</span></p><h3>RelatedActions</h3><table class=\"grid\"><tr><td>-</td><td><b>ActionId</b></td><td><b>Relationship</b></td><td><b>Offset[x]</b></td></tr><tr><td>*</td><td>check-suspected-disorder</td><td>before-start</td><td>1 h<span style=\"background: LightGoldenRodYellow\"> (Details: UCUM code h = 'h')</span></td></tr></table></blockquote><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the start of the check suspected disorder reporting workflow in response to the encounter-start event.</p><p><b>textEquivalent</b>: Check suspected disorders for immediate reportability and setup jobs for future reportability checks.</p><p><b>code</b>: Execute a series of actions to accomplish reporting <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#execute-reporting-workflow)</span></p><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the check for suspected disorder reportability to create the patients eICR.</p><p><b>textEquivalent</b>: Check Trigger Codes based on Suspected Reportable Value set.</p><p><b>code</b>: Evaluate candidate patient's data against trigger codes to determine reportability <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#check-trigger-codes)</span></p></blockquote><blockquote><p><b>action</b></p><p><b>code</b>: Evaluate condition to determine reportability <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#evaluate-condition)</span></p></blockquote></blockquote><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the check for suspected reportability of the eICR.</p><p><b>textEquivalent</b>: Check Reportability and setup jobs for future reportability checks.</p><p><b>code</b>: Execute a series of actions to accomplish reporting <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#execute-reporting-workflow)</span></p><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the check for reportability to create the patients eICR.</p><p><b>textEquivalent</b>: Check Trigger Codes based on RCTC Value sets.</p><p><b>code</b>: Evaluate candidate patient's data against trigger codes to determine reportability <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#check-trigger-codes)</span></p></blockquote><blockquote><p><b>action</b></p><p><b>code</b>: Evaluate condition to determine reportability <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#evaluate-condition)</span></p></blockquote><blockquote><p><b>action</b></p><p><b>code</b>: Evaluate condition to determine reportability <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#evaluate-condition)</span></p></blockquote></blockquote><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the creation of the eICR. It subsequently calls validate.</p><p><b>textEquivalent</b>: Create eICR</p><p><b>code</b>: Create a Report containing Patient's data for patients who passed the check-reportability test <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#create-report)</span></p><h3>RelatedActions</h3><table class=\"grid\"><tr><td>-</td><td><b>ActionId</b></td><td><b>Relationship</b></td></tr><tr><td>*</td><td>validate-eicr</td><td>before-start</td></tr></table></blockquote><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the validation of the eICR. It subsequently calls route-and-send.</p><p><b>textEquivalent</b>: Validate eICR</p><p><b>code</b>: Validate Report against specified profiles and terminologies. <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#validate-report)</span></p><h3>RelatedActions</h3><table class=\"grid\"><tr><td>-</td><td><b>ActionId</b></td><td><b>Relationship</b></td></tr><tr><td>*</td><td>route-and-send-eicr</td><td>before-start</td></tr></table></blockquote><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the routing and sending of the eICR.</p><p><b>textEquivalent</b>: Route and send eICR</p><p><b>code</b>: Submit the report to specified endpoint <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#submit-report)</span></p></blockquote><blockquote><p><b>action</b></p><p><b>description</b>: This action represents the start of the reporting workflow in response to the encounter-modified event</p><p><b>textEquivalent</b>: Start the reporting workflow in response to an encounter-modified event</p><p><b>code</b>: Initiate a reporting workflow <span style=\"background: LightGoldenRodYellow; margin: 4px; border: 1px solid khaki\"> (<a href=\"CodeSystem-us-ph-plandefinition-actions.html\">US Public Health PlanDefinition Action Codes</a>#initiate-reporting-workflow)</span></p><blockquote><p><b>condition</b></p><p><b>kind</b>: applicability</p></blockquote><h3>RelatedActions</h3><table class=\"grid\"><tr><td>-</td><td><b>ActionId</b></td><td><b>Relationship</b></td></tr><tr><td>*</td><td>create-eicr</td><td>before-start</td></tr></table></blockquote></div>"
  },
  "extension": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/variable",
      "valueExpression": {
        "name": "normalReportingDuration",
        "language": "text/fhirpath",
        "expression": "14"
      }
    }
  ],
  "url": "http://ersd.aimsplatform.org/fhir/PlanDefinition/us-ecr-specification",
  "version": "2.0.0",
  "name": "US_eCR_Specification",
  "title": "US eCR Specification",
  "type": {
    "coding": [
      {
        "system": "http://terminology.hl7.org/CodeSystem/plan-definition-type",
        "code": "workflow-definition",
        "display": "Workflow Definition"
      }
    ]
  },
  "status": "active",
  "experimental": true,
  "date": "2020-07-31T12:32:29.858-05:00",
  "publisher": "eCR",
  "contact": [
    {
      "name": "HL7 International - Public Health",
      "telecom": [
        {
          "system": "url",
          "value": "http://www.hl7.org/Special/committees/pher"
        }
      ]
    }
  ],
  "description": "An example ersd PlanDefinition",
  "jurisdiction": [
    {
      "coding": [
        {
          "system": "urn:iso:std:iso:3166",
          "code": "US",
          "display": "United States of America"
        }
      ],
      "text": "United States of America"
    }
  ],
  "effectivePeriod": {
    "start": "2020-12-01"
  },
  "relatedArtifact": [
    {
      "type": "depends-on",
      "label": "RCTC Value Set Library of Trigger Codes",
      "resource": "http://ersd.aimsplatform.org/fhir/Library/rctc"
    }
  ],
  "action": [
    {
      "id": "start-workflow",
      "description": "This action represents the start of the reporting workflow in response to the encounter-start event.",
      "textEquivalent": "Start the reporting workflow in response to an encounter-start event",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "initiate-reporting-workflow",
              "display": "Initiate a reporting workflow"
            }
          ]
        }
      ],
      "trigger": [
        {
          "id": "encounter-start",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-named-eventtype-extension",
              "valueCodeableConcept": {
                "coding": [
                  {
                    "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-triggerdefinition-namedevents",
                    "code": "encounter-start",
                    "display": "Indicates the start of an encounter"
                  }
                ]
              }
            }
          ],
          "type": "named-event",
          "name": "encounter-start"
        }
      ],
      "input": [
        {
          "id": "patient",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Patient/{{context.patientId}}"
            }
          ],
          "type": "Patient"
        },
        {
          "id": "encounter",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Encounter/{{context.encounterId}}"
            }
          ],
          "type": "Encounter"
        }
      ],
      "relatedAction": [
        {
          "actionId": "check-suspected-disorder",
          "relationship": "before-start",
          "offsetDuration": {
            "value": 1,
            "system": "http://unitsofmeasure.org",
            "code": "h"
          }
        }
      ]
    },
    {
      "id": "check-suspected-disorder",
      "description": "This action represents the start of the check suspected disorder reporting workflow in response to the encounter-start event.",
      "textEquivalent": "Check suspected disorders for immediate reportability and setup jobs for future reportability checks.",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "execute-reporting-workflow"
            }
          ]
        }
      ],
      "action": [
        {
          "id": "is-encounter-suspected-disorder",
          "description": "This action represents the check for suspected disorder reportability to create the patients eICR.",
          "textEquivalent": "Check Trigger Codes based on Suspected Reportable Value set.",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "check-trigger-codes"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Suspected Disorder?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|1.0.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%modifiedConditions.exists() or %modifiedLabResults.exists() or %modifiedMedicationOrders.exists()"
              }
            }
          ],
          "input": [
            {
              "id": "modifiedConditions",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Condition?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Condition",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/sdtc"
                }
              ]
            },
            {
              "id": "modifiedLabResults",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Observation?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Observation",
              "codeFilter": [
                {
                  "path": "value",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/sdtc"
                }
              ]
            },
            {
              "id": "modifiedMedicationOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "MedicationRequest?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "MedicationRequest",
              "codeFilter": [
                {
                  "path": "medication",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/sdtc"
                }
              ]
            }
          ],
          "relatedAction": [
            {
              "actionId": "create-eicr",
              "relationship": "before-start"
            }
          ]
        },
        {
          "id": "continue-check-reportable",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "evaluate-condition"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter In Progress and Within Normal Reporting Duration or 72h or less after end of encounter?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|1.0.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%encounter.where((status = 'in-progress' and period.start + 1 day * %normalReportingDuration >= now()) or (status = 'finished' and period.end + 72 hours >= now())).select(true)"
              }
            }
          ],
          "relatedAction": [
            {
              "actionId": "check-reportable",
              "relationship": "before-start",
              "offsetDuration": {
                "value": 6,
                "comparator": "&lt;=",
                "system": "http://unitsofmeasure.org",
                "code": "h"
              }
            }
          ]
        }
      ]
    },
    {
      "id": "check-reportable",
      "description": "This action represents the check for suspected reportability of the eICR.",
      "textEquivalent": "Check Reportability and setup jobs for future reportability checks.",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "execute-reporting-workflow"
            }
          ]
        }
      ],
      "action": [
        {
          "id": "is-encounter-reportable",
          "description": "This action represents the check for reportability to create the patients eICR.",
          "textEquivalent": "Check Trigger Codes based on RCTC Value sets.",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "check-trigger-codes"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter Reportable and Within Normal Reporting Duration?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|1.0.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%encounter.where(period.start + 1 day * %normalReportingDuration >= now()).select(true) and (%conditions.exists() or %encounters.exists() or %immunizations.exists() or %procedures.exists() or %procedureOrders.exists() or %labOrders.exists() or %labTests.exists() or %labResults.exists() or %medicationAdministrations.exists() or %medicationOrders.exists() or %medicationDispenses.exists())"
              }
            }
          ],
          "input": [
            {
              "id": "conditions",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Condition?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Condition",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/dxtc"
                }
              ]
            },
            {
              "id": "encounters",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter",
              "codeFilter": [
                {
                  "path": "reasonCode",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/dxtc"
                }
              ]
            },
            {
              "id": "immunizations",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Immunization?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Immunization",
              "codeFilter": [
                {
                  "path": "vaccineCode",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "labOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "ServiceRequest?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "ServiceRequest",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            },
            {
              "id": "labTests",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Observation?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Observation",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            },
            {
              "id": "diagnosticOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "DiagnosticReport?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "DiagnosticReport",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            },
            {
              "id": "procedureOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "ServiceRequest?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "ServiceRequest",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/pctc"
                }
              ]
            },
            {
              "id": "procedures",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Procedure?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Procedure",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/pctc"
                }
              ]
            },
            {
              "id": "medicationOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "MedicationRequest?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "MedicationRequest",
              "codeFilter": [
                {
                  "path": "medication",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "medicationDispenses",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "MedicationDispense?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "MedicationDispense",
              "codeFilter": [
                {
                  "path": "medication",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "medicationAdministrations",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "MedicationAdministration?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "MedicationAdministration",
              "codeFilter": [
                {
                  "path": "medication",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "labResults",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "labTests"
                }
              ],
              "type": "Observation",
              "codeFilter": [
                {
                  "path": "value",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/ostc"
                }
              ]
            },
            {
              "id": "diagnosticResults",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "diagnosticOrders"
                }
              ],
              "type": "DiagnosticReport",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/ostc"
                }
              ]
            }
          ],
          "relatedAction": [
            {
              "actionId": "create-eicr",
              "relationship": "before-start"
            }
          ]
        },
        {
          "id": "check-update-eicr",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "evaluate-condition"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Most recent eICR sent over 72 hours ago?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|1.0.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "((%lasteicr.last().entry[2].resource as Bundle).entry.first().resource as Composition).date < now() - 72 hours"
              }
            }
          ],
          "input": [
            {
              "id": "lasteicr",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "eicrreport"
                }
              ],
              "type": "Bundle",
              "profile": [
                "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
              ]
            }
          ],
          "relatedAction": [
            {
              "actionId": "create-eicr",
              "relationship": "before-start"
            }
          ]
        },
        {
          "id": "is-encounter-in-progress",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "evaluate-condition"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter In Progress and Within Normal Reporting Duration or 72h or less after end of encounter?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|1.0.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%inprogressencounter.where(status = 'in-progress' and period.start + 1 day * %normalReportingDuration >= now() or (status = 'finished' and period.end + 72 hours >= now())).exists()"
              }
            }
          ],
          "input": [
            {
              "id": "inprogressencounter",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ],
          "relatedAction": [
            {
              "actionId": "check-reportable",
              "relationship": "before-start",
              "offsetDuration": {
                "value": 6,
                "comparator": "&lt;=",
                "system": "http://unitsofmeasure.org",
                "code": "h"
              }
            }
          ]
        },
        {
          "id": "is-encounter-completed",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "complete-reporting"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter Complete",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|1.0.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%completedEncounter.exists(status = 'finished')"
              }
            }
          ],
          "input": [
            {
              "id": "completedEncounter",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ]
        }
      ]
    },
    {
      "id": "create-eicr",
      "description": "This action represents the creation of the eICR. It subsequently calls validate.",
      "textEquivalent": "Create eICR",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "create-report"
            }
          ]
        }
      ],
      "input": [
        {
          "id": "patientdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "patient"
            }
          ],
          "type": "Patient",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"
          ]
        },
        {
          "id": "conditiondata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "conditions"
            }
          ],
          "type": "Condition",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-condition"
          ]
        },
        {
          "id": "encounterdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "encounter"
            }
          ],
          "type": "Encounter",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-encounter"
          ]
        },
        {
          "id": "mrdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "medicationOrders"
            }
          ],
          "type": "MedicationRequest",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-medicationrequest"
          ]
        },
        {
          "id": "immzdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "immunizations"
            }
          ],
          "type": "Immunization",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-immunization"
          ]
        },
        {
          "id": "procdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "procedures"
            }
          ],
          "type": "Procedure",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-procedure"
          ]
        },
        {
          "id": "labResultdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "labResults"
            }
          ],
          "type": "Observation",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-lab"
          ]
        },
        {
          "id": "labOrderdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "labOrders"
            }
          ],
          "type": "ServiceRequest",
          "profile": [
            "http://hl7.org/fhir/StructureDefinition/ServiceRequest"
          ]
        },
        {
          "id": "diagnosticResultdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "diagnosticResults"
            }
          ],
          "type": "DiagnosticReport",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-lab"
          ]
        },
        {
          "id": "diagnosticOrderdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "diagnosticOrders"
            }
          ],
          "type": "DiagnosticReport",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-lab"
          ]
        }
      ],
      "output": [
        {
          "id": "eicrreport",
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "relatedAction": [
        {
          "actionId": "validate-eicr",
          "relationship": "before-start"
        }
      ]
    },
    {
      "id": "validate-eicr",
      "description": "This action represents the validation of the eICR. It subsequently calls route-and-send.",
      "textEquivalent": "Validate eICR",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "validate-report"
            }
          ]
        }
      ],
      "input": [
        {
          "id": "generatedeicrreport",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "eicrreport"
            }
          ],
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "output": [
        {
          "id": "valideicrreport",
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "relatedAction": [
        {
          "actionId": "route-and-send-eicr",
          "relationship": "before-start"
        }
      ]
    },
    {
      "id": "route-and-send-eicr",
      "description": "This action represents the routing and sending of the eICR.",
      "textEquivalent": "Route and send eICR",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "submit-report"
            }
          ]
        }
      ],
      "input": [
        {
          "id": "validatedeicrreport",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "valideicrreport"
            }
          ],
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "output": [
        {
          "id": "submittedeicrreport",
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ]
    },
    {
      "id": "encounter-modified",
      "description": "This action represents the start of the reporting workflow in response to the encounter-modified event",
      "textEquivalent": "Start the reporting workflow in response to an encounter-modified event",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "initiate-reporting-workflow",
              "display": "Initiate a reporting workflow"
            }
          ]
        }
      ],
      "trigger": [
        {
          "id": "encounter-modified-trigger",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-named-eventtype-extension",
              "valueCodeableConcept": {
                "coding": [
                  {
                    "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-triggerdefinition-namedevents",
                    "code": "encounter-modified",
                    "display": "Indicates modifications to data elements of an encounter"
                  }
                ]
              }
            }
          ],
          "type": "named-event",
          "name": "encounter-modified"
        }
      ],
      "condition": [
        {
          "kind": "applicability",
          "expression": {
            "extension": [
              {
                "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                "valueExpression": {
                  "language": "text/cql-identifier",
                  "expression": "Is Encounter Longer Than Normal Reporting Duration?",
                  "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|1.0.0"
                }
              }
            ],
            "language": "text/fhirpath",
            "expression": "%encounter.where(period.start + 1 day * %normalReportingDuration < now()).select(true)"
          }
        }
      ],
      "relatedAction": [
        {
          "actionId": "create-eicr",
          "relationship": "before-start"
        }
      ]
    }
  ]
}