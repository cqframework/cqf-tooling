{
  "resourceType": "PlanDefinition",
  "id": "us-ecr-specification",
  "meta": {
    "profile": [
      "http://hl7.org/fhir/us/ecr/StructureDefinition/ersd-plandefinition"
    ]
  },
  "text" : {
    "status" : "extensions",
    "div" : "<div xmlns=\"http://www.w3.org/1999/xhtml\">\n    <table class=\"grid dict\">\n        \n        <tr>\n            <th scope=\"row\"><b>Id: </b></th>\n            <td style=\"padding-left: 4px;\">us-ecr-specification</td>\n        </tr>\n        \n        \n        <tr>\n            <th scope=\"row\"><b>Url: </b></th>\n            <td style=\"padding-left: 4px;\"><a href=\"http://ersd.aimsplatform.org/fhir/PlanDefinition/us-ecr-specification\">http://ersd.aimsplatform.org/fhir/PlanDefinition/us-ecr-specification</a></td>\n        </tr>\n        \n        \n        <tr>\n            <th scope=\"row\"><b>Version: </b></th>\n            <td style=\"padding-left: 4px;\">2022.1.0</td>\n        </tr>\n        \n        \n        \n        <tr>\n            <th scope=\"row\"><b>Name: </b></th>\n            <td style=\"padding-left: 4px;\">US_eCR_Specification</td>\n        </tr>\n        \n        \n        <tr>\n            <th scope=\"row\"><b>Title: </b></th>\n            <td style=\"padding-left: 4px;\">US eCR Specification</td>\n        </tr>\n        \n        \n        \n        <tr>\n            <th scope=\"row\"><b>Status: </b></th>\n            <td style=\"padding-left: 4px;\">active</td>\n        </tr>\n        \n        \n        <tr>\n            <th scope=\"row\"><b>Experimental: </b></th>\n            <td style=\"padding-left: 4px;\">true</td>\n        </tr>\n        \n        \n        <tr>\n            <th scope=\"row\"><b>Type: </b></th>\n            <td style=\"padding-left: 4px;\">\n                \n                    \n                        \n                        <p style=\"margin-bottom: 5px;\">\n                            <b>system: </b> <span><a href=\"http://terminology.hl7.org/CodeSystem/plan-definition-type\">http://terminology.hl7.org/CodeSystem/plan-definition-type</a></span>\n                        </p>\n                        \n                        \n                        <p style=\"margin-bottom: 5px;\">\n                            <b>code: </b> <span>workflow-definition</span>\n                        </p>\n                        \n                        \n                        <p style=\"margin-bottom: 5px;\">\n                            <b>display: </b> <span>Workflow Definition</span>\n                        </p>\n                        \n                    \n                \n                \n            </td>\n        </tr>\n        \n        \n        \n        <tr>\n            <th scope=\"row\"><b>Date: </b></th>\n            <td style=\"padding-left: 4px;\">2023-03-31 12:32:29-0500</td>\n        </tr>\n        \n        \n        <tr>\n            <th scope=\"row\"><b>Publisher: </b></th>\n            <td style=\"padding-left: 4px;\">Centers for Disease Control and Prevention (CDC)</td>\n        </tr>\n        \n        \n        <tr>\n            <th scope=\"row\"><b>Description: </b></th>\n            <td style=\"padding-left: 4px;\">An example ersd PlanDefinition</td>\n        </tr>\n        \n        \n        \n        \n        \n        \n        <tr>\n            <th scope=\"row\"><b>Jurisdiction: </b></th>\n            <td style=\"padding-left: 4px;\">US</td>\n        </tr>\n        \n        \n        \n        \n        \n        \n        \n        <tr>\n            <th scope=\"row\"><b>Effective Period: </b></th>\n            <td style=\"padding-left: 4px;\">2020-12-01..</td>\n        </tr>\n        \n        \n        \n        <tr>\n          <th scope=\"row\"><b>Related Artifacts: </b></th>\n          <td style=\"padding-left: 4px;\">\n            \n            \n            \n            <p><b>Dependencies</b></p>\n            <ul>\n              \n                <li><a href=\"http://ersd.aimsplatform.org/fhir/Library/rctc\">http://ersd.aimsplatform.org/fhir/Library/rctc</a></li>\n              \n            </ul>\n            \n            \n            \n            \n            \n          </td>\n        </tr>\n        \n\n        \n        <tr>\n          <th scope=\"row\"><b>Libraries: </b></th>\n          <td style=\"padding-left: 4px;\">\n            <table class=\"grid-dict\">\n              \n                <tr><td><a href=\"http://fhir.org/guides/cdc/opioid-cds/Library/OpioidCDSREC11\">http://fhir.org/guides/cdc/opioid-cds/Library/OpioidCDSREC11</a></td></tr>\n              \n            </table>\n          </td>\n        </tr>\n        \n\n        \n        <tr>\n          <th scope=\"row\"><b>Actions: </b></th>\n          <td style=\"padding-left: 4px;\">\n            <table class=\"grid-dict\">\n              \n                <tr>\n                  <td>\n                    Start the reporting workflow in response to an encounter-start event<br/>\n                    <b>When:</b> <i>named-event:</i> encounter-start<br/>\n                    \n                    <b>Then:</b>\n                    \n                      \n                      \n                    \n                  </td>\n                </tr>\n              \n                <tr>\n                  <td>\n                    Check suspected disorders for immediate reportability and setup jobs for future reportability checks.<br/>\n                    \n                    \n                    <b>Then:</b>\n                    \n                      <table class=\"grid-dict\">\n                        \n                          <tr>\n                            <td>\n                              Check Trigger Codes based on Suspected Reportable and Lab Order Test Names Value set.<br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%suspectedDisorderConditions.exists() or %suspectedDisorderLabOrders.exists())</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                          <tr>\n                            <td>\n                              <b> :</b> <br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%inprogressencounter.where((status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration &amp;gt;= now()) or (status = 'finished' and %encounterEndDate + 72 hours &amp;gt;= now())).select(true))</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                          <tr>\n                            <td>\n                              <b> :</b> <br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%terminatedencounter.where((status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration &amp;lt; now()) or (status = 'finished' and %encounterEndDate + 72 hours &amp;lt; now())).select(true))</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                          <tr>\n                            <td>\n                              <b> :</b> <br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%lateCompletedEncounter.exists(status = 'finished'))</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                      </table>\n                    \n                  </td>\n                </tr>\n              \n                <tr>\n                  <td>\n                    Check Reportability and setup jobs for future reportability checks.<br/>\n                    \n                    \n                    <b>Then:</b>\n                    \n                      <table class=\"grid-dict\">\n                        \n                          <tr>\n                            <td>\n                              Check Trigger Codes based on RCTC Value sets.<br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>((%encounterStartDate + 1 day * %normalReportingDuration &amp;gt;= now()) and (%conditions.exists() or %encounters.exists() or %immunizations.exists() or %labOrders.exists() or %labTests.exists() or %labResults.exists() or %medicationAdministrations.exists() or %medicationOrders.exists() or %medicationDispenses.exists()))</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                          <tr>\n                            <td>\n                              <b> :</b> <br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%lastReportSubmissionDate &amp;lt; now() - 72 hours)</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                          <tr>\n                            <td>\n                              <b> :</b> <br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%inprogressencounter.where(status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration &amp;gt;= now() or (status = 'finished' and %encounterEndDate + 72 hours &amp;gt;= now())).exists())</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                          <tr>\n                            <td>\n                              <b> :</b> <br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%termencounter.where((status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration &amp;lt; now()) or (status = 'finished' and %encounterEndDate + 72 hours &amp;lt; now())).select(true))</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                          <tr>\n                            <td>\n                              <b> :</b> <br/>\n                              \n                              <b>If:</b> <i>applicability:</i>  <i>(%completedEncounter.exists(status = 'finished'))</i><br/>\n                              <b>Then:</b>\n                              \n                                \n                                \n                              \n                            </td>\n                          </tr>\n                        \n                      </table>\n                    \n                  </td>\n                </tr>\n              \n                <tr>\n                  <td>\n                    Create eICR<br/>\n                    \n                    \n                    <b>Then:</b>\n                    \n                      \n                      \n                    \n                  </td>\n                </tr>\n              \n                <tr>\n                  <td>\n                    Validate eICR<br/>\n                    \n                    \n                    <b>Then:</b>\n                    \n                      \n                      \n                    \n                  </td>\n                </tr>\n              \n                <tr>\n                  <td>\n                    Route and send eICR<br/>\n                    \n                    \n                    <b>Then:</b>\n                    \n                      \n                      \n                    \n                  </td>\n                </tr>\n              \n                <tr>\n                  <td>\n                    Start the reporting workflow in response to an encounter-modified event<br/>\n                    <b>When:</b> <i>named-event:</i> encounter-modified<br/>\n                    <b>If:</b> <i>applicability:</i>  <i>(%encounter.where(period.start + 1 day * %normalReportingDuration &amp;lt; now()).select(true))</i><br/>\n                    <b>Then:</b>\n                    \n                      \n                      \n                    \n                  </td>\n                </tr>\n              \n            </table>\n          </td>\n        </tr>\n        \n    </table>\n</div>"
  },
  "extension": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/variable",
      "valueExpression": {
        "name": "normalReportingDuration",
        "language": "text/fhirpath",
        "expression": "14"
      }
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/variable",
      "valueExpression":
      {
        "name": "encounterStartDate",
        "language": "text/fhirpath",
        "expression": "{{context.encounterStartDate}}"
      }
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/variable",
      "valueExpression":
      {
        "name": "encounterEndDate",
        "language": "text/fhirpath",
        "expression": "{{context.encounterEndDate}}"
      }
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/variable",
      "valueExpression":
      {
        "name": "lastReportSubmissionDate",
        "language": "text/fhirpath",
        "expression": "{{context.lastReportSubmissionDate}}"
      }
    }
  ],
  "url": "http://ersd.aimsplatform.org/fhir/PlanDefinition/us-ecr-specification",
  "version": "2.1.0",
  "name": "US_eCR_Specification",
  "title": "US eCR Specification",
  "type": {
    "coding": [
      {
        "system": "http://terminology.hl7.org/CodeSystem/plan-definition-type",
        "code": "workflow-definition",
        "display": "Workflow Definition"
      }
    ]
  },
  "status": "active",
  "experimental": true,
  "date": "2023-03-31T12:32:29.858-05:00",
  "publisher": "eCR",
  "contact": [
    {
      "name": "HL7 International - Public Health",
      "telecom": [
        {
          "system": "url",
          "value": "http://www.hl7.org/Special/committees/pher"
        }
      ]
    }
  ],
  "description": "An example ersd PlanDefinition",
  "jurisdiction": [
    {
      "coding": [
        {
          "system": "urn:iso:std:iso:3166",
          "code": "US",
          "display": "United States of America"
        }
      ],
      "text": "United States of America"
    }
  ],
  "effectivePeriod": {
    "start": "2020-12-01"
  },
  "relatedArtifact": [
    {
      "type": "depends-on",
      "label": "RCTC Value Set Library of Trigger Codes",
      "resource": "http://ersd.aimsplatform.org/fhir/Library/rctc"
    }
  ],
  "action": [
    {
      "id": "start-workflow",
      "description": "This action represents the start of the reporting workflow in response to the encounter-start event.",
      "textEquivalent": "Start the reporting workflow in response to an encounter-start event",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "initiate-reporting-workflow",
              "display": "Initiate a reporting workflow"
            }
          ]
        }
      ],
      "trigger": [
        {
          "id": "encounter-start",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-named-eventtype-extension",
              "valueCodeableConcept": {
                "coding": [
                  {
                    "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-triggerdefinition-namedevents",
                    "code": "encounter-start",
                    "display": "Indicates the start of an encounter"
                  }
                ]
              }
            }
          ],
          "type": "named-event",
          "name": "encounter-start"
        }
      ],
      "input": [
        {
          "id": "patient",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Patient/{{context.patientId}}"
            }
          ],
          "type": "Patient"
        },
        {
          "id": "encounter",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Encounter/{{context.encounterId}}"
            }
          ],
          "type": "Encounter"
        }
      ],
      "relatedAction": [
        {
          "actionId": "check-for-immediate-reporting",
          "relationship": "before-start",
          "offsetDuration": {
            "value": 1,
            "system": "http://unitsofmeasure.org",
            "code": "h"
          }
        }
      ]
    },
    {
      "id": "check-for-immediate-reporting",
      "description": "This action represents the start of the check suspected disorder reporting workflow in response to the encounter-start event.",
      "textEquivalent": "Check suspected disorders for immediate reportability and setup jobs for future reportability checks.",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "execute-reporting-workflow"
            }
          ]
        }
      ],
      "action": [
        {
          "id": "is-encounter-immediately-reportable",
          "description": "This action represents the check for suspected disorder reportability to create the patients eICR.",
          "textEquivalent": "Check Trigger Codes based on Suspected Reportable and Lab Order Test Names Value set.",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "check-trigger-codes"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Suspected Disorder?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%suspectedDisorderConditions.exists() or %suspectedDisorderLabOrders.exists()"
              }
            }
          ],
          "input": [
            {
              "id": "suspectedDisorderConditions",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Condition?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Condition",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/sdtc"
                }
              ]
            },
            {
              "id": "suspectedDisorderLabOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "ServiceRequest?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "ServiceRequest",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            },
            {
              "id": "diagnosticOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "DiagnosticReport?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "DiagnosticReport",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            }
          ],
          "relatedAction": [
            {
              "actionId": "create-eicr",
              "relationship": "before-start"
            }
          ]
        },
        {
          "id": "continue-check-reportable",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "evaluate-condition"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter In Progress and Within Normal Reporting Duration or 72h or less after end of encounter?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%inprogressencounter.where((status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration >= now()) or (status = 'finished' and %encounterEndDate + 72 hours >= now())).select(true)"
              }
            }
          ],
          "input":
          [
            {
              "id": "inprogressencounter",
              "extension":
              [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ],
          "relatedAction": [
            {
              "actionId": "check-reportable",
              "relationship": "before-start",
              "offsetDuration": {
                "value": 6,
                "comparator": "<=",
                "system": "http://unitsofmeasure.org",
                "code": "h"
              }
            }
          ]
        },
        {
          "id": "terminate-late-encounter",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "terminate-reporting-workflow"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter Late",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%terminatedencounter.where((status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration < now()) or (status = 'finished' and %encounterEndDate + 72 hours < now())).select(true)"
              }
            }
          ],
          "input": [
            {
              "id": "terminatedencounter",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ]
        },
        {
          "id": "is-late-encounter-completed",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "complete-reporting"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter Complete",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%lateCompletedEncounter.exists(status = 'finished')"
              }
            }
          ],
          "input": [
            {
              "id": "lateCompletedEncounter",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ]
        }
      ]
    },
    {
      "id": "check-reportable",
      "description": "This action represents the check for suspected reportability of the eICR.",
      "textEquivalent": "Check Reportability and setup jobs for future reportability checks.",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "execute-reporting-workflow"
            }
          ]
        }
      ],
      "action": [
        {
          "id": "is-encounter-reportable",
          "description": "This action represents the check for reportability to create the patients eICR.",
          "textEquivalent": "Check Trigger Codes based on RCTC Value sets.",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "check-trigger-codes"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter Reportable and Within Normal Reporting Duration?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "(%encounterStartDate + 1 day * %normalReportingDuration >= now()) and (%conditions.exists() or %diagnosticResultValues.exists() or %encounters.exists() or %immunizations.exists() or %labOrders.exists() or %labTests.exists() or %labResults.exists() or %labResultValues.exists() or %medicationAdministrations.exists() or %medicationOrders.exists() or %medicationDispenses.exists())"
              }
            }
          ],
          "input": [
            {
              "id": "conditions",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Condition?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Condition",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/dxtc"
                }
              ]
            },
            {
              "id": "encounters",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter",
              "codeFilter": [
                {
                  "path": "reasonCode",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/dxtc"
                }
              ]
            },
            {
              "id": "immunizations",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Immunization?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Immunization",
              "codeFilter": [
                {
                  "path": "vaccineCode",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "labOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "ServiceRequest?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "ServiceRequest",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            },
            {
              "id": "labTests",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "Observation?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "Observation",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            },
            {
              "id": "diagnosticOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "DiagnosticReport?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "DiagnosticReport",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lotc"
                }
              ]
            },
            {
              "id": "medicationOrders",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "MedicationRequest?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "MedicationRequest",
              "codeFilter": [
                {
                  "path": "medication",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "medicationDispenses",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "MedicationDispense?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "MedicationDispense",
              "codeFilter": [
                {
                  "path": "medication",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "medicationAdministrations",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
                  "valueString": "MedicationAdministration?patient=Patient/{{context.patientId}}"
                }
              ],
              "type": "MedicationAdministration",
              "codeFilter": [
                {
                  "path": "medication",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/mrtc"
                }
              ]
            },
            {
              "id": "labResults",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "labTests"
                }
              ],
              "type": "Observation",
              "codeFilter": [
                {
                  "path": "value",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/ostc"
                }
              ]
            },
            {
              "id": "labResultValues",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "labTests"
                }
              ],
              "type": "Observation",
              "codeFilter": [
                {
                  "path": "value",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lrtc"
                }
              ]
            },
            {
              "id": "diagnosticResults",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "diagnosticOrders"
                }
              ],
              "type": "DiagnosticReport",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/ostc"
                }
              ]
            },
            {
              "id": "diagnosticResultValues",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "diagnosticOrders"
                }
              ],
              "type": "DiagnosticReport",
              "codeFilter": [
                {
                  "path": "code",
                  "valueSet": "http://ersd.aimsplatform.org/fhir/ValueSet/lrtc"
                }
              ]
            }
          ],
          "relatedAction": [
            {
              "actionId": "create-eicr",
              "relationship": "before-start"
            }
          ]
        },
        {
          "id": "check-update-eicr",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "evaluate-condition"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Most recent eICR sent over 72 hours ago?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%lastReportSubmissionDate < now() - 72 hours"
              }
            }
          ],
          "relatedAction": [
            {
              "actionId": "create-eicr",
              "relationship": "before-start"
            }
          ]
        },
        {
          "id": "is-encounter-in-progress",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "evaluate-condition"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter In Progress and Within Normal Reporting Duration or 72h or less after end of encounter?",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%inprogressencounter.where(status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration >= now() or (status = 'finished' and %encounterEndDate + 72 hours >= now())).exists()"
              }
            }
          ],
          "input": [
            {
              "id": "inprogressencounter",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ],
          "relatedAction": [
            {
              "actionId": "check-reportable",
              "relationship": "before-start",
              "offsetDuration": {
                "value": 6,
                "comparator": "<=",
                "system": "http://unitsofmeasure.org",
                "code": "h"
              }
            }
          ]
        },
        {
          "id": "terminate-encounter",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "terminate-reporting-workflow"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter Late",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%termencounter.where((status = 'in-progress' and %encounterStartDate + 1 day * %normalReportingDuration < now()) or (status = 'finished' and %encounterEndDate + 72 hours < now())).select(true)"
              }
            }
          ],
          "input": [
            {
              "id": "termencounter",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ]
        },
        {
          "id": "is-encounter-completed",
          "code": [
            {
              "coding": [
                {
                  "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
                  "code": "complete-reporting"
                }
              ]
            }
          ],
          "condition": [
            {
              "kind": "applicability",
              "expression": {
                "extension": [
                  {
                    "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                    "valueExpression": {
                      "language": "text/cql-identifier",
                      "expression": "Is Encounter Complete",
                      "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                    }
                  }
                ],
                "language": "text/fhirpath",
                "expression": "%completedEncounter.exists(status = 'finished')"
              }
            }
          ],
          "input": [
            {
              "id": "completedEncounter",
              "extension": [
                {
                  "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
                  "valueString": "encounter"
                }
              ],
              "type": "Encounter"
            }
          ]
        }
      ]
    },
    {
      "id": "create-eicr",
      "description": "This action represents the creation of the eICR. It subsequently calls validate.",
      "textEquivalent": "Create eICR",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "create-report"
            }
          ]
        }
      ],
      "input": [
        {
          "id": "patientdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "patient"
            }
          ],
          "type": "Patient",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"
          ]
        },
        {
          "id": "conditiondata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "conditions"
            }
          ],
          "type": "Condition",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-condition"
          ]
        },
        {
          "id": "encounterdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "encounter"
            }
          ],
          "type": "Encounter",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-encounter"
          ]
        },
        {
          "id": "mrdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "medicationOrders"
            }
          ],
          "type": "MedicationRequest",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-medicationrequest"
          ]
        },
        {
          "id": "immzdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "immunizations"
            }
          ],
          "type": "Immunization",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-immunization"
          ]
        },
        {
          "id": "labResultdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "labResults"
            }
          ],
          "type": "Observation",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-lab"
          ]
        },
        {
          "id": "labOrderdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "labOrders"
            }
          ],
          "type": "ServiceRequest",
          "profile": [
            "http://hl7.org/fhir/StructureDefinition/ServiceRequest"
          ]
        },
        {
          "id": "diagnosticResultdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "diagnosticResults"
            }
          ],
          "type": "DiagnosticReport",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-lab"
          ]
        },
        {
          "id": "diagnosticOrderdata",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "diagnosticOrders"
            }
          ],
          "type": "DiagnosticReport",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-lab"
          ]
        },
        {
          "id": "odhData-loinc",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Observation?patient=Patient/{{context.patientId}}&code=http://loinc.org|11295-3"
            }
          ],
          "type": "Observation",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-social-history"
          ]
        },
        {
          "id": "odhData-snomed",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Observation?patient=Patient/{{context.patientId}}&code=http://snomed.info/sct|224362002,364703007"
            }
          ],
          "type": "Observation",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-social-history"
          ]
        },
        {
          "id": "pregnancyObservations",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Observation?patient=Patient/{{context.patientId}}&code=http://loinc.org|90767-5"
            }
          ],
          "type": "Observation",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-social-history"
          ]
        },
        {
          "id": "pregnancyConditions",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Condition?patient=Patient/{{context.patientId}}&code=http://snomed.info/sct|77386006"
            }
          ],
          "type": "Condition",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-condition"
          ]
        },
        {
          "id": "travelData-loinc",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Observation?patient=Patient/{{context.patientId}}&code=http://loinc.org|29762-2"
            }
          ],
          "type": "Observation",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-social-history"
          ]
        },
        {
          "id": "travelData-snomed",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Observation?patient=Patient/{{context.patientId}}&code=http://snomed.info/sct|161085007,443846001,420008001,46521000175102,34831000175105,161086008"
            }
          ],
          "type": "Observation",
          "profile": [
            "http://hl7.org/fhir/us/core/StructureDefinition/us-core-observation-social-history"
          ]
        }
      ],
      "output": [
        {
          "id": "eicrreport",
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "relatedAction": [
        {
          "actionId": "validate-eicr",
          "relationship": "before-start"
        }
      ]
    },
    {
      "id": "validate-eicr",
      "description": "This action represents the validation of the eICR. It subsequently calls route-and-send.",
      "textEquivalent": "Validate eICR",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "validate-report"
            }
          ]
        }
      ],
      "input": [
        {
          "id": "generatedeicrreport",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "eicrreport"
            }
          ],
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "output": [
        {
          "id": "valideicrreport",
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "relatedAction": [
        {
          "actionId": "route-and-send-eicr",
          "relationship": "before-start"
        }
      ]
    },
    {
      "id": "route-and-send-eicr",
      "description": "This action represents the routing and sending of the eICR.",
      "textEquivalent": "Route and send eICR",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "submit-report"
            }
          ]
        }
      ],
      "input": [
        {
          "id": "validatedeicrreport",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-relateddata-extension",
              "valueString": "valideicrreport"
            }
          ],
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ],
      "output": [
        {
          "id": "submittedeicrreport",
          "type": "Bundle",
          "profile": [
            "http://hl7.org/fhir/us/ecr/StructureDefinition/eicr-document-bundle"
          ]
        }
      ]
    },
    {
      "id": "encounter-modified",
      "description": "This action represents the start of the reporting workflow in response to the encounter-modified event",
      "textEquivalent": "Start the reporting workflow in response to an encounter-modified event",
      "code": [
        {
          "coding": [
            {
              "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-plandefinition-actions",
              "code": "initiate-reporting-workflow",
              "display": "Initiate a reporting workflow"
            }
          ]
        }
      ],
      "trigger": [
        {
          "id": "encounter-modified-trigger",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-named-eventtype-extension",
              "valueCodeableConcept": {
                "coding": [
                  {
                    "system": "http://hl7.org/fhir/us/ecr/CodeSystem/us-ph-triggerdefinition-namedevents",
                    "code": "encounter-modified",
                    "display": "Indicates modifications to data elements of an encounter"
                  }
                ]
              }
            }
          ],
          "type": "named-event",
          "name": "encounter-modified"
        }
      ],
      "condition": [
        {
          "kind": "applicability",
          "expression": {
            "extension": [
              {
                "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-alternative-expression-extension",
                "valueExpression": {
                  "language": "text/cql-identifier",
                  "expression": "Is Encounter Longer Than Normal Reporting Duration?",
                  "reference": "http://ersd.aimsplatform.org/fhir/Library/RuleFilters|2.1.0"
                }
              }
            ],
            "language": "text/fhirpath",
            "expression": "%encounter.where(period.start + 1 day * %normalReportingDuration < now()).select(true)"
          }
        }
      ],
      "input": [
        {
          "id": "modifiedPatient",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Patient/{{context.patientId}}"
            }
          ],
          "type": "Patient"
        },
        {
          "id": "modifiedEncounter",
          "extension": [
            {
              "url": "http://hl7.org/fhir/us/ecr/StructureDefinition/us-ph-fhirquerypattern-extension",
              "valueString": "Encounter/{{context.encounterId}}"
            }
          ],
          "type": "Encounter"
        }
      ],
      "relatedAction": [
        {
          "actionId": "create-eicr",
          "relationship": "before-start"
        }
      ]
    }
  ]
}